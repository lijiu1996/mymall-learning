# redis 部署经验

### 配置redis.conf 并且注册成系统服务

### 解决部署redis被防火墙问题

查询 firewall-cmd --query-port=6379/tcp
添加 firewall-cmd --add-port=6379/tcp --permanent
刷新 firewall-cmd --reload
重启redis systemctl restart redis

### 1. redis的数据类型

### 2. redis的过期策略

定期删除 + 惰性删除
每100ms随机抽查 + get访问的时候检查是否过期 

如果长时间没有被抽查 也没有get 大量内存堆积
--》 进行内存淘汰机制

### 3. 如何保证redis 高可用

性能数据

2020 淘宝双11订单峰值 58.3w/s tps

单机几万qps (mysql 2000 - 1w)
做了主从以后可以提高到10wqps
做了集群以后可以提高到几十wqps
本地缓存 caffeine - 1.5亿 guava - 2000w

考虑几个问题
上游rpc的线程池会不会挂 -- 客户端分布式缓存 不经过服务端直接请求缓存
是否存在热点商品 导致缓存单节点扛不住 -- 预热 
缓存击穿场景 兜底策略(访问db加锁保证单线程、热点商品探测、限流降级、)

主从架构

哨兵机制

### 4. redis 的雪崩、穿透和击穿

雪崩 -- 高可用 + 限流
穿透 -- 布隆过滤器
击穿 -- 热点key 互斥锁/逻辑过期

### 5. redis 缓存和数据库双写一致性

有没有比延时双删更优雅的解决方案 

路由加内存排列 将请求堆积在队列中 然后串行执行(相同唯一性的请求分发到一起)

先更新数据库 然后删除缓存 + 先查询缓存 查询不到查数据库 锁排队  

优化点1 更新操作在队列中直接组合
优化点2 读超时直接查库