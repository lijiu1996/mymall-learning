# mysql分库分表学习

### mysql 集群

分片算法 id范围分片/ 哈希分片
负载不均匀/负载均匀 rehash困难

### 1. 评估
* 单表数据量百万左右性能都十分优秀的
* 根据业务量预估进行分库分表数量选取
比如业务需要支持半年之内的查询 超过半年的数据进行归档
每日普通互联网公司订单量百万 阿里千万
那么半年的数据量就是 1.8亿 拆成256张表

### 2. 唯一主键

一般使用分布式唯一id生成器进行生成
比如雪花算法就是利用时间戳加机器id加序列号的方式进行id生成 

### 3. 分库分表后的查询、连表查询问题

* 首先选择好分库分表的键 让拆分后的查询尽量打在单表上 可以规避90%以上的问题
* 如果需要进行连表查询 使用唯一主键的话可以直接查
* 但若查询字段不是唯一主键 那么会很复杂 这个时候可以采用基因法 
比如将用户id包含在订单id的尾部 仍然走唯一id的查询
* 最终兜底的方案是数据进行异步双写 比如将数据写到c端数据库表的同时异步写到b端数据库表一份
查询的话用b端的表做查询 或者写到es这样支持更高数量级的中间件做查询
* 实在不行也可以查询多个数据库然后在内存里面进行join order by 等操作